---
version: "3.8"
services:
  jore4-jore3importer:
    # build and run the docker image from the local repo
    build:
      context: ..
    environment:
      # temporarily set custom environment variables until the e2e bundle is updated
      # set digiroad stops csv version
      - DIGIROAD_STOPS_CSV_VERSION=2022-02-03
      # a new jore4-db connection has been added
      - JORE4_DB_DATABASE=jore4e2e
      - JORE4_DB_HOSTNAME=jore4-testdb
      - JORE4_DB_USERNAME=dbimporter
      - JORE4_DB_PASSWORD=importerpassword
    secrets:
      # temporarily remapping the secrets while the e2e bundle is updated
      # destination-db has been renamed to importer-db
      - source: jore3importer-destination-db-database
        target: /mnt/secrets-store/importer-db-database
      - source: jore3importer-destination-db-hostname
        target: /mnt/secrets-store/importer-db-hostname
      - source: jore3importer-destination-db-password
        target: /mnt/secrets-store/importer-db-password
      - source: jore3importer-destination-db-username
        target: /mnt/secrets-store/importer-db-username

  importer-jooq-database:
    image: postgis/postgis:12-3.1-alpine
    container_name: importer-database
    restart: "unless-stopped"
    environment:
      - POSTGRES_DB=devdb
      - POSTGRES_USER=devdb
      - POSTGRES_PASSWORD=devdb
    ports:
      - "127.0.0.1:16000:5432"
    networks:
      - jore4

  importer-test-database:
    image: postgis/postgis:12-3.1-alpine
    container_name: importer-test-database
    environment:
      - POSTGRES_DB=importertestdatabase
      - POSTGRES_USER=importertestdatabase
      - POSTGRES_PASSWORD=importertestdatabase
    ports:
      - "127.0.0.1:17000:5432"
    networks:
      - jore4

  jore4-mssqltestdb:
    # pin compatible version of mssql schema
    image: "hsldevcom/jore4-mssql-testdb:schema-only-main--21ef30b56e38b0cfa118ccf610ba0fa7e9e00ef7"

networks:
    jore4:
